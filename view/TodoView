package com.example.exercice.view;

import com.example.exercice.model.Todo;
import com.example.exercice.viewmodel.TodoViewModel;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.control.*;
import javafx.scene.control.cell.CheckBoxTableCell;
import javafx.scene.control.cell.TextFieldTableCell;
import javafx.beans.binding.Bindings;
import javafx.beans.property.SimpleIntegerProperty;
import java.util.Objects;

public class TodoView {
    @FXML private TextField txtNew;
    @FXML private Button btnAdd, btnDel, btnDelAll, btnLogout;
    @FXML private CheckBox chkShowDone;
    @FXML private TableView<Todo> table;
    @FXML private TableColumn<Todo, String> colTitle;
    @FXML private TableColumn<Todo, Boolean> colDone;
    @FXML private TableColumn<Todo, Number> colLength;
    @FXML private Label lblPreview, lblWelcome;
    private final TodoViewModel vm;
    private final Parent root;

    public TodoView(TodoViewModel vm) throws Exception {
        this.vm = vm;
        FXMLLoader l = new FXMLLoader(Objects.requireNonNull(
                getClass().getResource("/view/TodoView.fxml"),
                "FXML /view/TodoView.fxml introuvable"));
        l.setController(this);
        this.root = l.load();
    }

    public Parent getRoot() {
        return root;
    }

    @FXML
    private void initialize() {
        table.setEditable(true);
        colDone.setEditable(true);
        table.setItems(vm.items());
        colTitle.setCellValueFactory(cd -> cd.getValue().titleProperty());
        colTitle.setCellFactory(TextFieldTableCell.forTableColumn());
        colDone.setCellValueFactory(cd -> cd.getValue().doneProperty());
        colDone.setCellFactory(CheckBoxTableCell.forTableColumn(colDone));

        colLength.setCellValueFactory(
                cd -> new SimpleIntegerProperty(cd.getValue().getTitle().length())
        );

        txtNew.textProperty().bindBidirectional(vm.newTitleProperty());
        chkShowDone.selectedProperty().bindBidirectional(vm.showDoneProperty());
        lblPreview.textProperty().bind(
                Bindings.concat("Vous allez ajouter : ", vm.newTitleProperty())
        );
        lblWelcome.textProperty().bind(
                Bindings.concat("Bienvenue, ", vm.usernameProperty())
        );

        btnAdd.setOnAction(e -> vm.add());
        btnDel.setOnAction(e -> {
            vm.selectedProperty().set(table.getSelectionModel().getSelectedItem());
            vm.deleteSelected();
            table.getSelectionModel().clearSelection();
        });
        btnDelAll.setOnAction(e -> vm.deleteAll());
        btnLogout.setOnAction(e -> {
        });
    }
}
